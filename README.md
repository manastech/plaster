# Plaster: Erisyon's Fluorosequencing Informatic Pipeline

This is the repository for Erisyon's analysis software for analyzing and simulating
runs on our fluorosequecning platform.

It consists of the following parts:

1. gen: A CLI tool that generates instructions for plaster.
1. run: The tool that runs the analysis. It is comprised of the following parts:
    * Sigproc: The signal processor that reads raw images from the instrument
       and coverts that into a "radmat" (rad-iometry mat-rix).
    * Simulator aka Virtual Fluoro-Sequencing (VFS): Uses an error model of the chemistry
       and instrument to produce simulated reads by Monte Carlo sampling.
       Used to train and evaluate the classifier.
    * Classifier: Trained against simulated reads, produces peptide or protein calls from reads,
       either real or simulated from VFS.

# Usage

1. Generate plaster instructions
    ```bash
    $ ./plaster.sh gen --help
    ```

1. Run plaster on those instructions
    ```bash
    $ ./plaster.sh run --help
    ```
   
## Example

VFS on ten random proteins from the Human Proteome with 4 labels.
Writes the "job" into `./jobs_folder/human_random_10`.

```bash
$ p gen classify \
  --job=human_random_10 \
  --sample='human_proteome_peptides_trypsin_edmans' \
  --protein_csv=s3://erisyon-public/reference_data/human_proteome_peptides_trypsin.csv \
  --protein_random=10 \
  --label_set='DE,Y,M,H' \
  --n_edmans=10 \
  --n_pres=1

$ p run ./jobs_folder/human_random_10
# Report output in ./jobs_folder/human_random_10/report.html
# or the notebook is in ./jobs_folder/human_random_10/report.ipynb
```


# Development

Source files are maintained on the host OS and but running tasks (tests, etc) is
done within a Docker container with the source files mounted into the container.

A bash script called "plaster.sh" is used to start the Docker container correct mode be that:
    * developer-mode: where the source is mounted from the host
    * user-mode: where the source is inside the container and individual commands are run

## Development Requirements

The following assumes you have OSX or Linux as the host environment.
If you are using Ubuntu Linux make sure you are on an LTS (.04) release.

1. Editor of your choice. PyCharm is quite nice and subsequent
   instructions will explain how to configure the so that PyCharm running
   on the Host OS (OSX) will be able to index the code.
   To install on Linux:
   sudo snap install pycharm-community --classic
1. "docker" installed.
    - Test: `sudo docker --version`
    - If not, Linux: `sudo apt install -y docker.io`; [OSX](https://docs.docker.com/docker-for-mac/install/)
1. "docker" needs to be runnable without sudo.
    - Test: `docker run hello-world`
    - If not: Linux: `sudo gpasswd -a $USER docker` and reboot; OSX: (Unknown, possibly the same?)
1. "git" installed.
    - If not: Linux: `sudo apt install git-all`; OSX: `brew install git`
1. "git config". If git has not been run it is important that git config is set up before your first run of ./p
    - `git config --global user.name "Your Name"`
    - `git config --global user.email "your@erisyon.com"`
1. Pull source, canonically in ~/git/erisyon, but you can put it where you need to.
   Henceforth, this readme will assume this path is in `$PLASTER_ROOT`
    - `git clone git@github.com:erisyon/plaster.git`
1. Create a directory or symlink in that same directory called "jobs_folder".
    - `cd PLASTER_ROOT && mkdir jobs_folder`
    - Alternatively, create a symbolic link to another folder: `ln -s /some/where/you/want/data $PLASTER_ROOT/jobs_folder`

## Development in the container

When the above requirements are complete you can run:

```bash
$ cd $PLASTER_ROOT
$ DEV=1 ./p
```

This mounts the host's source files into the container and drops you into a shell ready to run further commands.
You can now edit files in your host's IDE and run commands in this shell.

Examples
```bash
$ p --help
$ p test  # Runs all tests
```

## Setting up the host environment for IDEs

While development execution occurs in the docker container it is still
convenient to maintain a host environment so that your IDE (PyCharm, VS Code, etc)
is able to parse and produce indices even though you will not be executing that
code inside the container.

### OSX
```bash
$ xcode-select --install  # installs command-line tools if not already installed
$ brew install pyenv pipenv
$ cd $PLASTER_ROOT
$ pip3 install virtualenv
$ pyenv install 3.7.7
$ pipenv --python $(pyenv which python)
$ pipenv sync
```

### Linux, (Ubuntu 20.04)
```bash
$ cd $PLASTER_ROOT
$ pip3 install pipenv
$ pipenv sync
```

## Pip Dependencies

Our Python package manager is `pipenv`.
The `Pipfile` stores the dependencies.
The `Pipefile.lock` is generated by pipenv and stores the hashes and sources
of each dependency. Both files are version controlled.

### Dev Cookbook

Synchronize pip dependencies

```bash
$ pipenv sync
```

Add a pip dependency

```bash
$ pipenv install pip_package_name  # This will take a long time as it builds a new .lock file
```

## The "p" helper

All house-keeping tasks are in the "p" helper. See `p --help` for a complete list.

```bash
$ p --help            # See commands
$ p test              # Run all tests
$ p unit              # Run only unit tests
$ p unit foo          # Run only unit tests that have foo in their name
$ p jupyter           # Run local notebook server (see below)
$ p run_notebook      # Execute a specific notebook output as html
$ p black             # Run the code formatter
$ p nbstripout        # Strip output from all notebooks
$ p blastp            # Run NCBI blastp
$ p gen               # Plaster generator 
$ p run               # Plaster runner
```

### Jupyter

In order to start a local Jupyter you need to enable the port from the host. So before you go into
dev mode: `JUP=1 DEV=1 ./p jupyter` or `JUP=1 ./p jupyter` to run with the latest container.

